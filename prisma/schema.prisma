generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(uuid())
  auth0Id     String   @unique @map("auth0_id")
  email       String   @unique
  username    String   @unique
  firstName   String   @map("first_name")
  dateOfBirth DateTime @map("date_of_birth")
  avatarUrl   String?  @map("avatar_url") // User profile avatar image URL
  createdAt   DateTime @default(now()) @map("created_at")
  oneSignalPlayerId String? @map("onesignal_player_id") // OneSignal player ID for push notifications
  
  createdRooms    Room[] @relation("RoomCreatedBy")
  roomsNamedBy    Room[] @relation("RoomNameSetBy")
  roomParticipants RoomParticipant[]
  elements           Element[]
  comments           Comment[]
  roomReactions      RoomReaction[]
  
  // Following relationships
  followers    Follow[] @relation("UserFollowing") // People who follow me
  following    Follow[] @relation("UserFollowers") // People I follow
  
  // Denormalized counts for performance
  followersCount  Int @default(0) @map("followers_count")
  followingCount  Int @default(0) @map("following_count")
  
  @@index([username])
  @@index([firstName])
  @@index([username, firstName])
  @@map("users")
}

model Room {
  id           String   @id @default(uuid())
  name         String   // Required room name
  nameSetBy    String?  @map("name_set_by") // User who set the room name
  nameSetByUser User?   @relation("RoomNameSetBy", fields: [nameSetBy], references: [id])
  createdBy    String   @map("created_by")
  creator      User     @relation("RoomCreatedBy", fields: [createdBy], references: [id])
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at") // Track when room content is updated (elements, name, etc)
  commentsUpdatedAt DateTime? @map("comments_updated_at") // Track when comments were last added/deleted
  objectAddedAt DateTime @default(now()) @map("object_added_at") // Track when elements were last added
  reactionCount Int      @default(0) @map("reaction_count")
  lastReactionAt DateTime? @map("last_reaction_at")
  isActive     Boolean  @default(true) @map("is_active")
  isPublic     Boolean  @default(false) @map("is_public") // Room visibility: false = private (default), true = public
  
  participants RoomParticipant[]
  elements     Element[]
  comments     Comment[]
  reactions    RoomReaction[]
  
  @@map("rooms")
}

model RoomParticipant {
  roomId         String    @map("room_id")
  userId         String    @map("user_id")
  room           Room      @relation(fields: [roomId], references: [id])
  user           User      @relation(fields: [userId], references: [id])
  joinedAt       DateTime  @default(now()) @map("joined_at")
  leftAt         DateTime? @map("left_at") // Track when user left
  lastVisitedAt  DateTime  @default(now()) @map("last_visited_at") // Track when user last visited room
  color          String    // Hex color for touch circle
  isActive       Boolean   @default(true) @map("is_active")
  
  @@id([roomId, userId])
  @@index([userId]) // Speed up participant lookups
  @@map("room_participants")
}

model Element {
  id         String    @id @default(uuid())
  roomId     String    @map("room_id")
  room       Room      @relation(fields: [roomId], references: [id])
  type       ElementType
  createdBy  String    @map("created_by")
  creator    User      @relation(fields: [createdBy], references: [id])
  positionX  Float     @map("position_x")
  positionY  Float     @map("position_y")
  content    String?   // For notes and horoscopes
  imageUrl   String?   @map("image_url") // For photos
  audioUrl   String?   @map("audio_url") // For audio/voice notes
  videoUrl   String?   @map("video_url") // For videos
  thumbnailUrl String? @map("thumbnail_url") // For video thumbnails (large)
  smallThumbnailUrl String? @map("small_thumbnail_url") // 180px thumbnail for feed previews
  duration   Float?    // Audio/video duration in seconds
  stickerText String?  @map("sticker_text") // Optional custom text for LINK elements
  width      Float
  height     Float
  rotation   Float     @default(0) @map("rotation") // Rotation in degrees (0-360)
  scaleX     Float     @default(1) @map("scale_x") // Horizontal scale factor
  scaleY     Float     @default(1) @map("scale_y") // Vertical scale factor
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  deletedAt  DateTime? @map("deleted_at")
  
  referencedInComments Comment[]
  
  @@index([roomId, createdAt(sort: Desc)]) // For efficient recent elements query
  @@map("elements")
}

enum ElementType {
  NOTE
  PHOTO
  AUDIO
  HOROSCOPE
  VIDEO
  LINK
}

model Comment {
  id                    String       @id @default(uuid())
  roomId                String       @map("room_id")
  room                  Room         @relation(fields: [roomId], references: [id], onDelete: Cascade)
  userId                String       @map("user_id")
  user                  User         @relation(fields: [userId], references: [id])
  text                  String       @db.Text
  referencedElementId   String?      @map("referenced_element_id")
  referencedElement     Element?     @relation(fields: [referencedElementId], references: [id], onDelete: Cascade)
  referencedElementType ElementType? @map("referenced_element_type")
  createdAt             DateTime     @default(now()) @map("created_at")
  updatedAt             DateTime     @updatedAt @map("updated_at")
  deletedAt             DateTime?    @map("deleted_at")
  
  @@index([roomId, createdAt(sort: Desc)])
  @@index([referencedElementId])
  @@map("comments")
}

model RoomReaction {
  id        String   @id @default(uuid())
  roomId    String   @map("room_id")
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id])
  emoji     String   @default("❤️") @db.VarChar(10)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@unique([roomId, userId])
  @@index([roomId])
  @@index([userId])
  @@map("room_reactions")
}

model Follow {
  id          String   @id @default(uuid())
  followerId  String   @map("follower_id")
  followingId String   @map("following_id")
  follower    User     @relation("UserFollowers", fields: [followerId], references: [id])
  following   User     @relation("UserFollowing", fields: [followingId], references: [id])
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@unique([followerId, followingId]) // Prevent duplicate follows
  @@index([followerId]) // Fast lookup of who I follow
  @@index([followingId]) // Fast lookup of my followers
  @@map("follows")
}

